AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Resources:

  meetBelTestTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    Properties:
      TableName: meetBelTestTable
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: CostCentre
          Value: meetBelPreProdTesting

  cakesAPI:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
      Cors:
        AllowHeaders: "'Authorization, content-type'"
        AllowOrigin: "'*'"
      Auth:
        AddDefaultAuthorizerToCorsPreflight: false # removes auth requirement from 'options' pre-flight requests

  getCakesFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: build/getCakes.getCakesRestHandler
      Runtime: nodejs10.x
      CodeUri: .
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref meetBelTestTable
      Description: >-
        Get Cakes
      MemorySize: 128
      Timeout: 10
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          NODE_ENV: dev
          MEETBEL_TEST_TABLE_NAME: !Ref meetBelTestTable
      Events:
        Api1:
          Type: Api
          Properties:
            RestApiId: !Ref cakesAPI
            Path: /
            Method: get
